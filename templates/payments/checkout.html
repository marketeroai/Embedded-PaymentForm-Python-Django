{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - Izipay{% endblock %}

{% block extra_head %}
<!-- Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/journal/bootstrap.min.css"
    integrity="sha384-QDSPDoVOoSWz2ypaRUidLmLYl4RyoBWI44iA5agn6jHegBxZkNqgm2eHb6yZ5bYs" crossorigin="anonymous" />

<!-- Estilos de la pasarela de pagos -->
<link rel="stylesheet" href="https://static.micuentaweb.pe/static/js/krypton-client/V4.0/ext/classic.css">
{% endblock %}

{% block content %}
<section class="container">
    <div class="row">
        <div class="col-md-3"></div>
        <div class="center-column col-md-6">
            <section class="payment-form">
                <div class="row">
                    <div class="col-12">
                        <h4 class="mb-3">Monto a pagar: S/. {{ payment.amount }}</h4>
                        <p>Pago con tarjeta de crédito/débito</p>
                        <img src="https://github.com/izipay-pe/Imagenes/blob/main/logo_tarjetas_aceptadas/logo-tarjetas-aceptadas-351x42.png?raw=true" 
                             alt="Tarjetas aceptadas" 
                             style="width: 200px;">
                    </div>
                </div>
                <hr>
                <div id="micuentawebstd_rest_wrapper">
                    <div class="kr-embedded" kr-form-token="{{ token }}"></div>
                </div>
                <div id="debug-info" class="mt-3">
                    <pre id="debug-output"></pre>
                </div>
            </section>
        </div>
        <div class="col-md-3"></div>
    </div>
</section>

<!-- Scripts at the end of body -->
<script type="text/javascript">
    console.log('Script initialization started');
    
    function initKR() {
        var KR = new KRGlue.KR(function(error) {
            if (error) {
                console.error('KR error:', error);
                return;
            }
            console.log('KR initialized successfully');
        });

        KR.setFormConfig({
            formToken: "{{ token }}",
            language: "es-ES"
        }).then(function(v) {
            console.log('Form config set');
            return KR.addForm("#micuentawebstd_rest_wrapper");
        }).then(function(v) {
            console.log('Form added');
            return KR.showForm(KR.result.formId);
        }).catch(function(error) {
            console.error('Error:', error);
        });
    }
</script>

<!-- Libreria JS de la pasarela -->
<script 
    src="https://static.micuentaweb.pe/static/js/krypton-client/V4.0/stable/kr-payment-form.min.js" 
    kr-public-key="{{ publickey }}"
    kr-post-url-success="{% url 'payments:success' %}"
    kr-post-url-refused="{% url 'payments:failed' %}"
    kr-language="es-Es"
    onload="initKR()">
</script>

<!-- Javascript con el objeto KR -->
<script src="https://static.micuentaweb.pe/static/js/krypton-client/V4.0/ext/classic.js"></script>
{% endblock %}